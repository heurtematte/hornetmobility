<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="partenaire">

    <resultMap class="fr.gouv.diplomatie.applitutoriel.business.bo.Partenaire" id="mapPartenaire">
        <result column="ID_PARTENAIRE" property="id" />
        <result column="ID_VILLE" property="ville" resultMap="ville.mapVille" />
        <result column="ID_CIVILITE" property="civilite" resultMap="civilite.mapCivilite" />
        <result column="ID_PAYS" property="nationalite" resultMap="pays.mapPaysPartenaireNationalite" />
        <result column="PAR_IS_CLIENT" property="isClient" />
        <result column="PAR_IS_VIP" property="isVIP" />
        <result column="PAR_NOM" property="nom" />
        <result column="PAR_PRENOM" property="prenom" />
        <result column="PAR_NOM_LOCAL" property="nomLocal" />
        <result column="PAR_PRENOM_LOCAL" property="prenomLocal" />
        <result column="PAR_FONCTION" property="fonction" />
        <result column="PAR_PRO_TEL_FIXE" property="proTelFixe" />
        <result column="PAR_PRO_TEL_PORT" property="proTelPort" />
        <result column="PAR_PRO_COURRIEL" property="proCourriel" />
        <result column="PAR_PRO_FAX" property="proFax" />
        <result column="PAR_PRO_ADR_CP" property="proAdrCP" />
        <result column="PAR_PRO_ADR_RUE" property="proAdrRue" />        
        <result column="PAR_ASSIST_NOM" property="assistNom" />
        <result column="PAR_ASSIST_PRENOM" property="assistPrenom" />
        <result column="PAR_ASSIST_TEL" property="assistTel" />
        <result column="PAR_ASSIST_COURRIEL" property="assistCourriel" />
        <result column="PAR_COMMENTAIRE" property="commentaire" />
        <result column="PAR_ORGANISME" property="organisme" />
        <result column="PAR_DATE_CREATION" property="dateCrea" />
        <result column="PAR_DATE_MODIFICATION" property="dateModif" />
    </resultMap>

    <resultMap class="fr.gouv.diplomatie.applitutoriel.business.bo.Partenaire" id="mapPartenaireCriteres">
        <result column="ID_PARTENAIRE" property="id" />
        <result column="PAR_IS_CLIENT" property="isClient" />
        <result column="PAR_IS_VIP" property="isVIP" />
        <result column="PAR_NOM" property="nom" />
        <result column="PAR_PRENOM" property="prenom" />
        <result column="PAR_PRO_COURRIEL" property="proCourriel" />
        <result column="PAR_ORGANISME" property="organisme" />
        <result column="PAR_FONCTION" property="fonction" />
        <result column="PAR_DATE_CREATION" property="dateCrea" />
        <result column="PAR_DATE_MODIFICATION" property="dateModif" />
    </resultMap>

    <sql id="selectPartenaire_fragment">
        SELECT 
			ID_PARTENAIRE,
			VILLE.*, PAYS.*,
			CIVILITE.*,
			PAR_IS_CLIENT, PAR_IS_VIP,
			nationalite.ID_PAYS as idNationalite, nationalite.PAY_NATIONALITE as libelleNationalite,
			PAR_NOM, PAR_PRENOM, PAR_NOM_LOCAL, PAR_PRENOM_LOCAL, PAR_FONCTION,
			PAR_PRO_TEL_FIXE, PAR_PRO_TEL_PORT, PAR_PRO_COURRIEL, PAR_PRO_FAX,
			PAR_PRO_ADR_CP, PAR_PRO_ADR_RUE,
			PAR_ASSIST_NOM, PAR_ASSIST_PRENOM, PAR_ASSIST_TEL, PAR_ASSIST_COURRIEL,
			PAR_COMMENTAIRE, PAR_ORGANISME, PAR_DATE_CREATION, PAR_DATE_MODIFICATION
        FROM PARTENAIRE
            INNER JOIN CIVILITE ON CIVILITE.ID_CIVILITE = PARTENAIRE.ID_CIVILITE
            INNER JOIN PAYS AS nationalite ON nationalite.ID_PAYS = PARTENAIRE.ID_PAYS 
            INNER JOIN VILLE ON VILLE.ID_VILLE = PARTENAIRE.ID_VILLE 
            INNER JOIN PAYS ON VILLE.ID_PAYS = PAYS.ID_PAYS
    </sql>
    
    <select id="select" resultMap="mapPartenaire">
        <include refid="selectPartenaire_fragment" />
        ORDER BY PAR_NOM ASC;
    </select>
    
    <select id="selectById" resultMap="mapPartenaire">
        <include refid="selectPartenaire_fragment" />
        WHERE ID_PARTENAIRE = #id#;
    </select>
    
    <select id="selectByCriteres" resultMap="mapPartenaireCriteres">
        SELECT 
            DISTINCT PARTENAIRE.ID_PARTENAIRE, PAR_IS_CLIENT, PAR_IS_VIP, PAR_NOM, PAR_PRENOM,
            PAR_PRO_COURRIEL, PAR_ORGANISME, PAR_FONCTION, PAR_DATE_CREATION, PAR_DATE_MODIFICATION
        FROM PARTENAIRE
            <isNotNull property="idSecteur">
                <isNotEqual property="idSecteur" compareValue="0">
                    INNER JOIN PRODUIT_PARTENAIRE ON PRODUIT_PARTENAIRE.ID_PARTENAIRE = PARTENAIRE.ID_PARTENAIRE
                    INNER JOIN PRODUIT ON PRODUIT.ID_PRODUIT = PRODUIT_PARTENAIRE.ID_PRODUIT AND PRODUIT.ID_SECTEUR = #idSecteur#
                </isNotEqual>
            </isNotNull>
        <dynamic prepend="WHERE">
            <isNotNull property="partenaire.isClient" prepend="AND">
            PAR_IS_CLIENT = #partenaire.isClient#
            </isNotNull>
            <isNotEmpty property="partenaire.nom" prepend="AND">
            UPPER(PAR_NOM) like UPPER('%'+#partenaire.nom#+'%')
            </isNotEmpty>
            <isNotEmpty property="partenaire.prenom" prepend="AND">
            UPPER(PAR_PRENOM) like UPPER('%'+#partenaire.prenom#+'%')
            </isNotEmpty>
            <isNotEmpty property="partenaire.proCourriel" prepend="AND">
            UPPER(PAR_PRO_COURRIEL) like UPPER('%'+#partenaire.proCourriel#+'%')
            </isNotEmpty>
            <isNotEmpty property="partenaire.organisme" prepend="AND">
            UPPER(PAR_ORGANISME) like UPPER('%'+#partenaire.organisme#+'%')
            </isNotEmpty>
            <isNotEmpty property="partenaire.dateModif" prepend="AND">
            DATEDIFF('dd', PAR_DATE_MODIFICATION, #partenaire.dateModif#) = 0
            </isNotEmpty>
            <isEqual property="partenaire.isVIP" compareValue="true" prepend="AND">
            PAR_IS_VIP = 1
            </isEqual>
            <isEqual property="partenaire.isVIPFiltre" compareValue="true" prepend="AND">
            PAR_IS_VIP = 1
            </isEqual>
            <isNotNull property="startDate" prepend="AND">
            DATEDIFF('dd', PAR_DATE_MODIFICATION, #startDate#) &lt;= 0
            </isNotNull>
            <isNotNull property="endDate" prepend="AND">
            DATEDIFF('dd', PAR_DATE_MODIFICATION, #endDate#) &gt;= 0
            </isNotNull>
        </dynamic>
        GROUP BY 
            PARTENAIRE.ID_PARTENAIRE, PAR_IS_CLIENT, PAR_IS_VIP, PAR_NOM, PAR_PRENOM, 
            PAR_PRO_COURRIEL, PAR_ORGANISME, PAR_FONCTION, PAR_DATE_CREATION, PAR_DATE_MODIFICATION
        ORDER BY LOWER(PAR_NOM) ASC;
    </select>
    
    <insert id="insert" parameterClass="fr.gouv.diplomatie.applitutoriel.business.bo.Partenaire">
        INSERT INTO PARTENAIRE 
        (
            ID_VILLE, ID_CIVILITE, ID_PAYS, PAR_IS_CLIENT, PAR_IS_VIP,
            PAR_NOM, PAR_PRENOM, PAR_NOM_LOCAL, PAR_PRENOM_LOCAL, PAR_FONCTION,
            PAR_PRO_TEL_FIXE, PAR_PRO_TEL_PORT, PAR_PRO_COURRIEL, PAR_PRO_FAX,
            PAR_PRO_ADR_CP, PAR_PRO_ADR_RUE,
            PAR_ASSIST_NOM, PAR_ASSIST_PRENOM, PAR_ASSIST_TEL, PAR_ASSIST_COURRIEL,
            PAR_COMMENTAIRE, PAR_ORGANISME,
            PAR_DATE_CREATION, PAR_DATE_MODIFICATION
        ) 
        VALUES 
        (
            #ville.id#, #civilite.id#, #nationalite.id#, #isClient#, #isVIP#,
            #nom#, #prenom#, #nomLocal#,  #prenomLocal#, #fonction#,
            #proTelFixe#, #proTelPort#, #proCourriel#, #proFax#,
            #proAdrCP#, #proAdrRue#,
            #assistNom#, #assistPrenom#, #assistTel#, #assistCourriel#,
            #commentaire#, #organisme#,
            #dateCrea#, #dateModif#
        );
        <selectKey keyProperty="id" resultClass="decimal">
            call IDENTITY()
        </selectKey>
    </insert>
    
    <update id="update" parameterClass="fr.gouv.diplomatie.applitutoriel.business.bo.Partenaire">
        UPDATE PARTENAIRE SET 
            ID_VILLE = #ville.id#, ID_CIVILITE = #civilite.id#, ID_PAYS = #nationalite.id#, 
			PAR_IS_CLIENT = #isClient#, PAR_IS_VIP = #isVIP#, 
			PAR_NOM = #nom#, PAR_PRENOM = #prenom#, PAR_NOM_LOCAL = #nomLocal#, PAR_PRENOM_LOCAL = #prenomLocal#, PAR_FONCTION = #fonction#, 
			PAR_PRO_TEL_FIXE = #proTelFixe#, PAR_PRO_TEL_PORT = #proTelPort#, PAR_PRO_COURRIEL = #proCourriel#, PAR_PRO_FAX = #proFax#, 
			PAR_PRO_ADR_CP = #proAdrCP#, PAR_PRO_ADR_RUE = #proAdrRue#, 
			PAR_ASSIST_NOM = #assistNom#, PAR_ASSIST_PRENOM = #assistPrenom#, PAR_ASSIST_TEL = #assistTel#, PAR_ASSIST_COURRIEL = #assistCourriel#, 
			PAR_COMMENTAIRE = #commentaire#, PAR_ORGANISME = #organisme#, PAR_DATE_MODIFICATION = #dateModif#
        WHERE ID_PARTENAIRE = #id#
    </update>
    
    <delete id="delete" parameterClass="fr.gouv.diplomatie.applitutoriel.business.bo.Partenaire" >
        DELETE FROM PARTENAIRE WHERE ID_PARTENAIRE = #id#
    </delete>
</sqlMap>