YUI.add("hornet-googlemaps-overlay",function(g){var d=g.Lang,b=d.sub,a=d.isNumber,h="container",c="strings",f=g.YUI2;function e(i){this.adresse="";this.latitude=0;this.longitude=0;this._map=null;e.superclass.constructor.apply(this,arguments);}e.NAME="hornetGooglemapsOverlay";e.ATTRS={gmapsUri:{value:"http://maps.google.com/maps/api/js?callback={callback}&language=fr&libraries=adsense,geometry&sensor=false&v=3.4"},timeout:{value:30000},width:{value:"800px"},height:{value:"500px"},latitudeRef:{value:"46.2276380"},longitudeRef:{value:"2.2137490"},strings:{valueFn:function(){return g.Intl.get("hornet-googlemaps-overlay");},setter:function(i){return g.merge(this.get("strings"),i);}}};g.extend(e,g.Widget,{CONTENT_BODY_TEMPLATE:"<div class='yui3-widget-bd'></div>",CONTENT_POPUP_TEMPLATE:"<div>{adresse}"+"<div>"+"<b>Latitude : </b>{latitude}<br/>"+"<b>Longitude : </b>{longitude}"+"</div></div>",initializer:function(){this._infowindow=null;this._marker=null;this._gmapsLoaded=false;this.publish("info");this.publish("failure");this.publish("select");g.publish("googlemaps:load",{broadcast:2,fireOnce:true,async:true});},renderUI:function(){var l=this,i=l.get("strings"),m=l.get("boundingBox"),k=l.get("contentBox");var j=new f.widget.Dialog(k.getDOMNode(),{fixedcenter:true,visible:false,modal:true,buttons:[{text:i.select,handler:g.bind(function(){l._onSelect();l.hide();},l),isDefault:true},{text:i.cancel,handler:g.bind(function(){l.hide();},l)}],draggable:false,close:true});j.hideEvent.subscribe(function(){if(l.get("visible")==true){l.hide();}});j.setHeader(i.title);j.setBody(l.CONTENT_BODY_TEMPLATE);j.render(m.getDOMNode());l._overlay=j;l._containerBody=g.one(j.body).one("*");l.renderGMapsUI();},renderGMapsUI:function(){if(typeof(google)!=="undefined"){this._gmapsOnLoad();}else{g.on("googlemaps:load",g.bind(this._gmapsOnLoad,this));if(!e._loading){e._loading=true;this._loadGMaps(function(){g.fire("googlemaps:load");});}}},bindGMapsUI:function(){var i=this;google.maps.event.addListener(this._map,"click",function(j){var k=j.latLng;i._setPositionGps.apply(i,[k.lat(),k.lng()]);});google.maps.event.addListener(this._marker,"click",function(){i._setPositionGps.apply(i,[i.latitude,i.longitude]);});google.maps.event.addListener(this._marker,"dragend",function(j){var k=j.latLng;i._setPositionGps.apply(i,[k.lat(),k.lng()]);});},show:function(){if(this._overlay){this._overlay.show();}},hide:function(){if(this._overlay){this._overlay.hide();}},_uiSetDim:function(j,k){var i=(this._containerBody||this.get("boundingBox"));i.setStyle(j,a(k)?k+this.DEF_UNIT:k);},_gmapsOnLoad:function(){var j=this,i=j._containerBody,m=j.get("latitudeRef")||0,l=j.get("longitudeRef")||0,k=new google.maps.LatLng(m,l);if(i){j._map=new google.maps.Map(i.getDOMNode(),{zoom:2,center:k,mapTypeId:google.maps.MapTypeId.ROADMAP});j._geocoder=new google.maps.Geocoder();j._infowindow=this._getInfosLocalisation();j._marker=new google.maps.Marker({clickable:true,draggable:true,visible:true,map:j._map});j.bindGMapsUI();j._gmapsLoaded=true;}},_loadGMaps:function(m){var j=this,i=j.get("strings"),l=j.get("timeout"),k=j.get("gmapsUri");g.jsonp(k,{context:j,on:{failure:function(){j._onError(i.errorLoading);},success:m,timeout:function(){j._onError(i.errorLoading);}},timeout:l});},_onSelect:function(){this.fire("select",{latitude:this.latitude,longitude:this.longitude,adresse:this.adresse});},_onError:function(i){this.fire("failure",{msg:i});},_onInfo:function(i){this.fire("info",{msg:i});},_setLocationOnMap:function(i){if(this._marker){this._marker.setPosition(i);}if(!this._map.getCenter()){this._map.setCenter(i);}else{this._map.panTo(i);}this._infowindow.setContent(b(this.CONTENT_POPUP_TEMPLATE,{adresse:this.adresse,latitude:this.latitude,longitude:this.longitude}));this._infowindow.open(this._map,this._marker);},_getInfosLocalisation:function(){return new google.maps.InfoWindow({content:b(this.CONTENT_POPUP_TEMPLATE,{adresse:this.adresse,latitude:this.latitude,longitude:this.longitude})});},_calculeAdresse:function(k,i){var j="";if((0<i)&&(i<=5)){j=j+this._extractAdressByType(k.address_components,"country");}else{if(6==i){j=j+this._extractAdressByType(k.address_components,"administrative_area_level_1");if(j!=""){j=j+", ";}j=j+this._extractAdressByType(k.address_components,"country");}else{if(7==i){j=j+this._extractAdressByType(k.address_components,"administrative_area_level_2");if(j!=""){j=j+", ";}j=j+this._extractAdressByType(k.address_components,"administrative_area_level_1");if(j!=""){j=j+", ";}j=j+this._extractAdressByType(k.address_components,"country");}else{if((8<=i)&&(i<=11)){j=j+this._extractAdressByType(k.address_components,"locality");if(j!=""){j=j+", ";}j=j+this._extractAdressByType(k.address_components,"country");}else{j=k.formatted_address;}}}}return j;},_extractAdressByType:function(l,m){var k="";var i=(l.length)-1;var j=false;while(i>=0&&!j){if(l[i].types[0]==m){k=l[i].long_name;j=true;}i=(i-1);}return k;},_updatePositionGps:function(j,i){this.latitude=i.lat().toFixed(7);this.longitude=i.lng().toFixed(7);this.adresse=this._calculeAdresse(j,this._map.getZoom());this._setLocationOnMap(i);},_setPositionGps:function(m,k){var j=this,i=this.get("strings"),l=new google.maps.LatLng(m,k);this._geocoder.geocode({"latLng":l},function(o,n){if(n==google.maps.GeocoderStatus.OK){if(o[0]){j._updatePositionGps.apply(j,[o[0],l]);}}else{j._onInfo(i.infoLocationNotFound);}});},openPositionGps:function(k,j){var i=this.get("strings");this.show();if(this._gmapsLoaded){if(k!=""&&j!=""){this._setPositionGps(k,j);}else{this._onInfo(i.infoPositionSearched);}}else{this._onError(i.errorNotLoaded);}},_updateAdresse:function(j){var i=j.geometry.location;this.latitude=i.lat().toFixed(7);this.longitude=i.lng().toFixed(7);this.adresse=j.formatted_address;if(j.types[0]=="street_address"||j.types[0]=="route"){this._map.setZoom(16);}else{if(j.types[0]=="locality"){this._map.setZoom(10);}else{if(j.types[0]=="administrative_area_level_1"||j.types[0]=="administrative_area_level_2"){this._map.setZoom(7);
}else{if(j.types[0]=="country"){this._map.setZoom(5);}}}}this._setLocationOnMap(i);},_setAdresse:function(k){var j=this,i=this.get("strings");this._geocoder.geocode({"address":k},function(m,l){if(l==google.maps.GeocoderStatus.OK){if(m[0]){j._updateAdresse.apply(j,[m[0]]);}}else{j._onInfo(i.infoLocationNotFound);}});},openAdresse:function(j){var i=this.get("strings");this.show();if(this._gmapsLoaded){if(j!=""){this._setAdresse(j);}else{this._onInfo(i.infoAdresseSearched);}}else{this._onError(i.errorNotLoaded);}}});g.namespace("hornet").googlemapsOverlay=e;},"3.3.0",{skinnable:false,requires:["yui2-container","yui2-button","widget-base","event-custom","jsonp"],lang:["fr"]});
